<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>云电脑自助领取dnf网吧福利 - DNF每日疲劳领取网吧特权云电脑出租</title>
    <meta name="Keywords" content="DNF网吧云电脑,地下城与勇士,网吧特权,dnf50疲劳代领，dnf在家网吧特权">
    <meta name="Description" content="网吧特权在家怎么领取，2021年代领50疲劳，史诗网吧特权领取,dnf网吧疲劳代领，2021在家使用dnf网吧特权">
    <!--引用bootstrap的css-->
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.6.0/css/bootstrap.min.css" />
    <!--引用bootstrap图标库css-->
    <link rel="stylesheet" href="https://cdn.staticfile.org/bootstrap-icons/1.4.0/font/bootstrap-icons.min.css" />
    <!--本地的css文件-->
    
    <!--toast插件-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/whoisyourlove/dnfCdn/Scripts/Toast/css/toast.css" />
    <!--animate.css-->
    <link rel="stylesheet" href="https://cdn.staticfile.org/animate.css/4.1.1/animate.min.css" />
    
    <style>
        .TechImg {
            width: 100%;
            border: 1px solid #909acc;
            border-radius: 0px 0px 10px 10px;
        }

        .page {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            z-index: 100;
            overflow-y: auto;
        }

        .display {
            background-color: #6d6d6d;
            color: #979797;
        }

        #page_1 {
            background-image: url(https://cdn.jsdelivr.net/gh/whoisyourlove/dnfCdn/Image/bg.png);
        }

        .tipText {
            position: absolute;
            top: 50%;
            left: 0px;
            right: 0px;
            font-size: 2.6rem;
            color: red;
            background-color: rgb(73 73 73 / 19%);
            margin: 0px 16px;
            box-shadow: inset 0px 0px 20px 1px #b2b2b285;
        }
    </style>

</head>
<body>
    


<div id="page">
    
    <div class="page" id="page_1" style="z-index:103;">
        <div class="container text-center app">
            

            <div class="container-fluid" id="codeVerify">
                <nav class="navbar navbar-expand-lg navbar-light bg-light">
                    
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a class="nav-link text-success" href="" data-toggle="modal" data-target="#exampleModal"><strong>两分钟视频演示</strong></a>
                            </li>
                            <li class="nav-item" v-show="hidePrice">
                                <a class="nav-link text-success" href="https://www.6fak.cn/product/8066FBF806C836CC" target="_blank"><strong>购买单次口令</strong></a>
                            </li>
                            <li class="nav-item" v-show="hidePrice">
                                <a class="nav-link text-success" href="https://www.6fak.cn/product/7A544F89866D2284" target="_blank"><strong>购买30次优惠口令</strong></a>
                            </li>
                            <li class="nav-item" v-show="hidePrice">
                                <a class="nav-link text-success" href="tencent://message/?uin=2847046608" target="_blank"><strong>系统故障/联系售后QQ:2847046608</strong></a>
                            </li>
                        </ul>
                    </div>
                </nav>
                
                <h1 class="display-5" style="margin-top:50px;margin-bottom:20px;">网吧云电脑在线租用</h1>
                <div class="input-group input-group-lg">
                    <input v-on:keyup.enter="verification" type="text" v-model="inputCode" class="form-control" placeholder="请在这里输入通行口令 自助使用网吧云电脑" aria-label="Username" aria-describedby="basic-addon1">
                    <div class="input-group-prepend">
                        <button class="btn  btn-success" :class="{'display':socketIsOk == false}" v-on:click="verification">立即使用</button>
                    </div>
                </div>
                <div class="alert alert-success text-left" role="alert" style="margin-top:20px;">
                    <p>DNF史诗特权网吧云电脑 <strong>出租12分钟</strong>，自助使用，全天24小时无人值守</p>
                    <p>每天 每个大区都可领取一次 <span class="badge badge-success">50点疲劳药</span>和 Lv100传说套装，欢迎长期使用，助力勇士闪光毕业</p>
                    <p>腾讯出于安全考虑，首次异地登陆可能会提示(冻结,密码被修改,密码可能泄露) 无需担心，领取完毕后修改密码即可恢复</p>
                </div>

                <div class="alert alert-primary text-left" role="alert">
                    正在排队<span class="badge badge-success">{{queueMsg.queCount}}</span>人,当前云设备 <span class="badge" :class="queueMsg.matchNum == '0' ? 'badge-danger' : 'badge-success'">{{queueMsg.matchNum == "0" ? '都在使用中' : '有空闲'}}</span>...下面是简易图片教程，你也可以观看<a href="#" class="badge badge-success" style=" padding: 4px; font-size: 0.9rem;" data-toggle="modal" data-target="#exampleModal">视频教程</a>
                </div>
                <div class="row row-no-gutters">
                    <div class="col-6 col-xl-6">
                        <img src="https://cdn.jsdelivr.net/gh/whoisyourlove/dnfCdn/Image/tech0.jpg" class="TechImg" />
                        <div class="tipText">
                            1.填入你的口令
                        </div>
                    </div>
                    <div class="col-6 col-xl-6">
                        <img src="https://cdn.jsdelivr.net/gh/whoisyourlove/dnfCdn/Image/tech1.jpg" class="TechImg" />
                        <div class="tipText">
                            2.可能需要排队
                        </div>
                    </div>

                    <div class="col-12 col-xl-12" style="height:20px;"></div>

                    <div class="col-6 col-xl-6">
                        <img src="https://cdn.jsdelivr.net/gh/whoisyourlove/dnfCdn/Image/tech2.jpg" class="TechImg" />
                        <div class="tipText">
                            3.手机QQ扫码登陆
                        </div>
                    </div>
                    <div class="col-6 col-xl-6">
                        <img src="https://cdn.jsdelivr.net/gh/whoisyourlove/dnfCdn/Image/tech3.jpg" class="TechImg" />
                        <div class="tipText">
                            4.活动栏点击网吧图标领取
                        </div>
                    </div>

                    <div class="col-12 col-xl-12" style="height:20px;"></div>
                    <div class="col-6 col-xl-6">
                        <img src="https://cdn.jsdelivr.net/gh/whoisyourlove/dnfCdn/Image/tech4.jpg" class="TechImg" />
                        <div class="tipText">
                            5.接收邮件
                        </div>
                    </div>
                    <div class="col-6 col-xl-6">
                        <img src="https://cdn.jsdelivr.net/gh/whoisyourlove/dnfCdn/Image/tech5.jpg" class="TechImg" />
                        <div class="tipText">
                            6.消耗品栏 鼠标右键吃掉后 结束游戏
                        </div>
                    </div>
                </div>
                <div class="alert alert-success text-center" role="alert" style="margin-top:20px;">
                    网吧云电脑 &copy;{{new Date().getFullYear()}}
                </div>

            </div>

        </div>
    </div>
    
    <div class="page" id="page_2" style="z-index:102;">
        <div class="container">
            <div class="jumbotron jumbotron-fluid" style="box-shadow: rgb(106 124 143) 0px 0px 10px 4px; border-radius: 0px 0px 20px 20px;">
                <div class="container">
                    <h1 class="display-4">
                        <span v-show="matchedText != ''" class="text-danger">
                            {{matchedText}}
                        </span>
                        <span v-show="matchedText == ''">
                            需要排队，您排在第
                            <span style="color:red;">{{Number(queueMsg.whereMe)+1}}</span>
                            个
                        </span>

                    </h1>
                    <div class="spinner-border text-primary" role="status" style="float:left;"></div>
                    <div>
                        <div class="lead" style="padding-left:7px;">
                            请稍等,排到您后会自动进入...
                        </div>
                        <div class="lead" style="clear:both;">
                            <br />
                            匹配成功后 才会扣除口令次数。您可以继续等待,或随时退出排队...
                        </div>
                        <br /><br />
                        <div>
                            <button class="btn  btn-danger" v-on:click="exitQueue()"><i class="bi bi-reply-all"></i> 退出排队 有空再来</button>
                            <div class="form-check" style="margin-top:5px;">
                                <input class="form-check-input" type="checkbox" v-model="playMusicOnUse" id="defaultCheck1" style="width: 24px; height: 24px;">
                                <label class="form-check-label" for="defaultCheck1" style="vertical-align: middle;">
                                    &nbsp;匹配成功后播放背景音乐提醒我
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <hr />
            <div class="alert alert-success" role="alert">
                口令信息:{{codeMsg.mark || ""}}
                <h6>本口令剩余可用次数<span style="color:red">{{codeMsg.hasCount}}</span>次</h6>
                <h6>本口令每日使用上限<span>{{codeMsg.everyDayCanUse}}</span>次</h6>
            </div>

            <div style=" border-radius: 5px;">
                <p>本口令近期使用记录:</p>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">使用者编号</th>
                            <th scope="col">使用者IP</th>
                            <th scope="col">使用时间</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(obj,ind) in codeHisList">
                            <th scope="row">{{ind}}</th>
                            <td>{{obj.UsedId}}</td>
                            <td>{{obj.UsedIp}}</td>
                            <td>{{obj.UseDate}}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div style="height:30px;"></div>

        </div>
    </div>

    
    <div class="page" id="page_3" style="z-index:101;">
        <div class="container-fluid">
            <div class="row no-gutters" style=" position: absolute; top: 0px; bottom: 0px; left: 0px; right: 0px;overflow:hidden;">
                <div class="col-9" style=" padding: 0px 1px;">
                    <nav class="navbar navbar-expand-lg navbar-light bg-light" style="padding:4px;background-color: #000000a1 !important;">
                        <div class="collapse navbar-collapse" id="navbarNavDropdown">
                            <ul class="navbar-nav  mr-auto avbar-expand-sm">
                                <li id="reloadGame" class="nav-item" style="margin-left:10px;" v-on:click="reloadGame">
                                    <a class="nav-link btn btn-success" style="color:white;" href="#">
                                        <i class="bi bi-bootstrap-reboot"></i>
                                        重启游戏
                                    </a>
                                </li>
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle btn btn-success" style="color:white;margin-left:10px;" href="#" id="navbarDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <i class="bi bi-tv"></i>
                                        画质调整
                                    </a>
                                    <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                                        <a class="dropdown-item" href="#" onclick="app.imRez = 6;">更流畅</a>
                                        <a class="dropdown-item" href="#" onclick="app.imRez = 15;">正常</a>
                                        <a class="dropdown-item" href="#" onclick="app.imRez = 30;">更清晰</a>
                                    </div>
                                </li>
                                <li class="nav-item" style="margin-left:10px;">
                                    <a class="nav-link" style="color:white;" href="#">
                                        <i class="bi bi-alarm"></i>
                                        操作时间:{{matchedHasTime}}
                                    </a>
                                </li>
                            </ul>
                            <ul class="navbar-nav">
                                <li class="nav-item dropdown">
                                    <a target="_blank" style="color:white;margin-left:10px;" class="nav-link btn btn-info" href="http://a.dwz.win/?https://gamesafe.qq.com/safety-remove.shtml">
                                        <i class="bi bi-link-45deg"></i>
                                        解除安全模式
                                    </a>
                                </li>
                                <li class="nav-item dropdown" style="margin-right:10px;">
                                    <a class="nav-link dropdown-toggle btn btn-info" style="color:white;margin-left:10px;" href="#" id="navbarDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">

                                        口令信息
                                    </a>
                                    <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                                        <a class="dropdown-item" href="#">{{inputCode}}</a>
                                        <a class="dropdown-item" href="#">剩余使用次数{{codeMsg.hasCount}}</a>
                                        <a class="dropdown-item" href="#">今日可用次数{{codeMsg.everyDayCanUse-codeMsg.usedToday}}</a>
                                    </div>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link btn btn-danger" style="color:white;margin-right:10px;" href="#" v-on:click="ending()">
                                        <i class="bi bi-box-arrow-right"></i>领取完毕/退出游戏
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </nav>
                    <div id="yunImgDiv" style=" position: absolute; padding: 7px; text-align: center;background-color: #fbf3ff; top: 49px; bottom: 1px; left: 1px; right: 1px;">
                        <canvas id="canvasScreen" width="200" height="200" style="max-width:100%;max-height:100%;opacity:0.9;">
                            哎呀浏览器不支持
                        </canvas>
                        
                    </div>
                </div>
                <div class="col-3" style="padding: 0px 1px;height:100%;">
                    <div style="width:100%;height:100%;">
                        <div class="alert alert-primary" role="alert" style="margin-bottom:1px;">
                            当前操作提示：
                        </div>
                        <ul class="list-group small">
                            <li class="list-group-item" v-for="(obj,ind) in gameTipList" :style="{padding: (!!obj.noPadding) ? '0px' : '10px'}" style="font-size: 1rem;">
                                <div v-show="obj.showLoading && ind == 0" class="spinner-border text-primary" role="status" style="float:left;"></div>
                                <div v-if="ind == 0" class="text-danger h5 animate__animated animate__headShake animate__infinite" v-html="obj.txt"></div>
                                <div v-if="ind != 0" v-html="obj.txt"></div>
                            </li>
                        </ul>
                        <div style="position:absolute;bottom:0px;width:100%;">
                            <audio style="width:100%;" controls="controls" :autoplay="playMusicOnUse" loop="loop" preload="auto" id="MusicPlayer" src=""></audio>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <div class="container-fluid">
        <!-- 模态框 -->
        <div class="modal fade" id="exampleModal">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">

                    <!-- 模态框头部 -->
                    <div class="modal-header">
                        <h4 class="modal-title">两分钟视频演示</h4>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>

                    <!-- 模态框主体 -->
                    <div class="modal-body" style="padding: 0px; overflow: hidden; height: 529px;">
                        <iframe style=" width: 100%; height: 566px;" src="//player.bilibili.com/player.html?aid=544762495&bvid=BV1Vi4y1P785&cid=314612570&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe>
                    </div>

                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" tabindex="-1" id="closeAQModel" data-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">准备解除安全模式</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>登录成功后，可能会进入安全模式，安全模式中无法使用任何道具...</p>
                    <p>为了节省您的时间，建议您先做好解除准备...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">暂不</button>
                    <a href="http://a.dwz.win/?https://gamesafe.qq.com/safety-remove.shtml" onclick="$('#closeAQModel').modal('hide')" target="_blank" class="btn btn-primary">去准备解除</a>
                </div>
            </div>
        </div>
    </div>
    
    <audio src="https://cdn.jsdelivr.net/gh/whoisyourlove/dnfCdn/Scripts/ppmp3.mp3" id="myaudio" hidden="hidden"></audio>

</div>



    <!--引用vue-->
    <script src="https://cdn.staticfile.org/vue/3.0.7/vue.global.js" accesskey=""></script>
    <!--vue的路由-->
    
    <!--引用jquery-->
    <script src="https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js"></script>
    <!--引用boostrap的js-->
    <script src="https://cdn.staticfile.org/twitter-bootstrap/4.6.0/js/bootstrap.min.js"></script>
    <!--toast插件-->
    <script src="https://cdn.jsdelivr.net/gh/whoisyourlove/dnfCdn/Scripts/Toast/js/toast.js"></script>
    <script>
        function toast(title, body, t) {
            if (!t) {
                t = 4000;
            }
            $.toast({
                title: title,
                subtitle: '提示',
                content: body,
                type: 'info',
                delay: t,
                //img: {
                //    src: 'image.png',
                //    class: 'rounded',
                //    title: 'Thumbnail Title',
                //    alt: 'Alternative'
                //},
                pause_on_hover: false
            });
        };
    </script>
    <!--本地的js文件-->
    <script src="https://cdn.jsdelivr.net/gh/whoisyourlove/dnfCdn/Scripts/site.js" asp-append-version="true"></script>
    
    <script>
        //ie
        if (!!window.ActiveXObject || "ActiveXObject" in window) {
            alert("哎呀!IE浏览器无法使用，请使用其他浏览器打开本网站..");
            document.body.innerHTML = "<h1>微软已经停止对IE浏览器的更新了，请更换其他浏览器再打开本网站，谢谢...</h1>";
        }
        //微信
        var ua = window.navigator.userAgent.toLowerCase();
        if (ua.match(/MicroMessenger/i) == 'micromessenger') {
            var system = {
                win: false,
                mac: false
            };
            //检测平台
            var p = navigator.platform;
            system.win = p.indexOf("Win") == 0;
            system.mac = p.indexOf("Mac") == 0;
            //是微信
            if (system.win || system.mac) {
                alert("哎呀!不支持微信内置的浏览器，请使用其他浏览器打开本网站..");
                document.body.innerHTML = "<h1>微信浏览器不支持某些功能，请更换其他浏览器再打开本网站，谢谢...</h1>";
            }
        }

    </script>
    <script>
        var app = Vue.createApp({
            data() {
                return {
                    socketIsOk: false,//socket是否连接成功了 用于控制按钮变灰
                    matchedText: "",//是否已经匹配成功显示的文字 用于判断是否匹配成功
                    matchedHasTime: "-",//匹配剩余时间
                    inputCode: localStorage.code || "",//输入的口令
                    queueMsg: { //当前排队的信息
                        queCount: "",//当前队列总人数
                        whereMe: "",//我排第几个
                        imInQueue: false,//我现在在排队吗？
                        matchNum: "1" //当前剩余闲置的电脑
                    },
                    codeMsg: { //口令的信息
                        allCount: 0, //发行的总额度
                        hasCount: 0,//剩余可用次数
                        mark: "", //中文说明
                        everyDayCanUse: 0, //每日最多可用次数
                        usedToday: 0 //今日已使用次数
                    },
                    showPage: "page_1",//当前打开的页面,
                    codeUsedList: [],//当前口令的历史记录
                    imRez: 15,//图像压缩率 5   20
                    lastTimeGetImage: new Date(),//上次获得图像的时间
                    lastTimeGetNewImage: new Date(),//上次获得新图的时间
                    baseImageXy: { //原始图像的像素
                        x: 0,
                        y: 0
                    },
                    gameTipList: [], //第三页右边的提示列表
                    codeHisList: [],//第二页的历史消费记录
                    nowTerminalState: "",//当前终端机的状态,
                    onCloseReLoad: true,//当断开时，是否重新连接
                    playMusicOnUse: localStorage.music == "No" ? false : true, //匹配后自动播放音乐
                    hidePrice: getQueryVariable("hp") ? false : true //隐藏价格

                }
            }, methods: {
                //验证输入的口令按钮
                verification() {
                    if (!app.socketIsOk) {
                        return;
                    }
                    app.socketIsOk = false;
                    app.inputCode = app.inputCode.trim()

                    localStorage.code = app.inputCode;
                    //发送验证的Socket
                    sendSocket({
                        code: "verifiCode",
                        msg1: app.inputCode
                    });
                    toast("提示", "正在验证 请稍等...", 3000);
                },
                exitQueue() {
                    sendSocket({
                        code: "exitQueue",
                        msg1: app.inputCode
                    });
                    setTimeout(function () {
                        location.reload();
                    }, 500);
                },
                //匹配成功 5秒倒计时
                Matching(t) {
                    if (t <= 0) {
                        app.showPage = "page_3";//当前打开的页面
                        return;
                    }
                    var thist = t;
                    app.matchedText = "已经匹配了云电脑，" + thist + "秒后自动进入，请勿离开....";
                    setTimeout(function () { app.Matching(thist - 1) }, 1000);
                },
                //重新打开游戏
                reloadGame() {
                    //是否？？？？？？？？？
                    if (confirm("游戏登陆需要一两分钟时间，这时候没有画面属于正常现象，确认结束游戏并重新打开吗？")) {
                        sendSocket({
                            code: "userMessage",
                            msg1: "1"
                        });
                        //$("#reloadGame").remove();
                    }
                },
                //领取完成
                ending() {
                    if (confirm("本操作会关闭云端游戏,并结束本次服务，确定已经领取并吃掉疲劳药了吗？")) {
                        sendSocket({
                            code: "userMessage",
                            msg1: "2"
                        });
                        setTimeout(function () { location.reload(); }, 1000);
                    }
                },
                //根据code获取最近的历史消费记录
                getHisFromCode() {
                    $.ajax({
                        url: "/user/GetHisFromCode?code=" + app.inputCode,
                        data: {},
                        success: function (a, b) {
                            a = a.replaceAll(/T/g, " ")
                            app.codeHisList = JSON.parse(a);
                        },
                    });
                },
                //获取背景音乐的html
                SetMusic() {
                    //风一样的勇士【木吉他指弹】
                    //风一样的勇士（国乐版）
                    //地下城与勇士DNF国服10周年庆BGM钢琴无缝串烧
                    //神之都-根特
                    //赫顿玛尔
                    var ids = ["534676419", "1330249440", "862308698", "38019935", "1313793743"];
                    try {
                        $("#MusicPlayer").attr("src", `//music.163.com/song/media/outer/url?id=${ids[parseInt(Math.random() * (ids.length), 10)]}.mp3`);
                    } catch (e) { }
                }
            }, watch: {
                showPage(n, o) {
                    if (n == o) return;

                    $(".page").css("z-index", "100");
                    $("#" + n).css("z-index", "199");
                    $("#" + o).css("z-index", "200");

                    $(".page").show();

                    animateCSS('#' + o, 'zoomOutDown').then((message) => {
                        $("#" + o).hide();
                    });
                },
                playMusicOnUse(n, o) {
                    if (n) {
                        localStorage.music = "Yes"
                    } else {
                        localStorage.music = "No"
                    }
                }
            }
        }).mount('#page');

        var canvas1 = document.getElementById("canvasScreen");
        var cxt1 = canvas1.getContext("2d");

        function openSocket() {
            try {
                if (location.host.indexOf("localhost") != -1) {
                    window.socket = new WebSocket("ws://127.0.0.1:8203");
                } else {
                    window.socket = new WebSocket("ws://119.28.14.83:8203");
                }

                socket.onopen = function () {
                    app.socketIsOk = true;
                    console.log("open了");
                    //发送id
                    sendSocket({
                        code: "openSocket",
                        msg1: "user",
                        msg2: getUid()
                    });
                };
                socket.onmessage = function (evt) {
                    //console.log(evt.data);
                    obj = JSON.parse(evt.data);
                    switch (obj.code) {
                        case "webBackPic"://获取到的图像
                            app.lastTimeGetImage = new Date();

                            //是新图
                            if (!!obj.msg3) {
                                app.lastTimeGetNewImage = new Date();

                                var nowx = Number(obj.msg1);
                                var nowy = Number(obj.msg2);

                                app.baseImageXy = {
                                    x: nowx,
                                    y: nowy
                                }

                                if (canvas1.width != nowx) {
                                    canvas1.width = nowx;
                                    canvas1.height = nowy;
                                }

                                var img = new Image();
                                img.src = "data:image/jpeg;base64," + obj.msg3;
                                img.ind = obj.msg5;
                                img.onload = function () {
                                    var beginHei = app.baseImageXy.y / 14 * Number(this.ind)
                                    cxt1.drawImage(img, 0, beginHei, img.width, img.height)
                                }

                            }
                            //try {
                            //    var ttt = JSON.parse(obj.msg4);
                            //    console.log(ttt);
                            //    console.log("终端传服务器:" + (Number(ttt.msg2) - Number(ttt.msg1)) + ",服务器接收到web请求:" + (Number(ttt.msg4) - Number(ttt.msg3)) + ",服务器返回到web:" + (new Date().getTime() - Number(ttt.msg4)));
                            //} catch (e) { }

                            if (obj.msg5 == "13") { //最后一帧
                                setTimeout(function () { getImage(); }, 120);
                            }

                            break;
                        case "terminalBackState": //终端机的状态
                            app.nowTerminalState = obj.msg1;
                            switch (obj.msg1) {
                                case "1":
                                    app.gameTipList.unshift({ showLoading: true, txt: "正在打开游戏,请耐心等待..." });
                                    break;
                                case "2": //句柄获取完成
                                    app.gameTipList.unshift({ showLoading: false, txt: "正在加载游戏TP中，请耐心等待..." });
                                    getImage();
                                    //长时间没有图像就重新获取
                                    setInterval(function () {
                                        if (new Date() - app.lastTimeGetImage > 6000) {
                                            getImage();
                                        }
                                    }, 2000);
                                    break;
                                case "3":
                                    app.gameTipList.unshift({ showLoading: false, txt: "请选择你所在的大区" });
                                    break;
                                case "3-1":
                                    app.gameTipList.unshift({ noPadding: true, txt: `<img src="https://cdn.jsdelivr.net/gh/whoisyourlove/dnfCdn/Image/erweima.jpg" style="width:100%;" />` });
                                    app.gameTipList.unshift({ showLoading: false, txt: "TP加载完毕后，如果没有自动弹出二维码,请手动点击下图二维码:" });
                                    break;
                                case "4":
                                    app.gameTipList.unshift({ showLoading: false, txt: "<strong><span class='text-success'>暂不支持手机令牌（动态6位密码）</span>如果您开启了手机令牌，请在APP中暂时关闭,否则无法登录</strong>" });
                                    app.gameTipList.unshift({ showLoading: false, txt: "可使用<h1>手机QQ</h1>扫码登陆" });
                                    toast("", "使用<h1 class='text-danger'>手机QQ</h1>扫码登陆", 6000);
                                    break;
                                case "4-1":
                                    app.gameTipList.unshift({ noPadding: true, txt: `<strong><span class='text-primary'>所有道具均只能在网吧使用。疲劳药吃掉后再退出。网吧装备穿上身再退出</span></strong>。</br><img src="https://cdn.jsdelivr.net/gh/whoisyourlove/dnfCdn/Image/tip2.jpg" style="width:100%;" />` });
                                    app.gameTipList.unshift({ showLoading: true, txt: "登陆游戏中,可能需要两三分钟时间,请耐心等待..." });
                                    break;
                                case "5":
                                    app.gameTipList.unshift({ showLoading: false, txt: '<img src="https://cdn.jsdelivr.net/gh/whoisyourlove/dnfCdn/Image/tip.jpg" style="width:100%;" />' });
                                    app.gameTipList.unshift({ noPadding: false, showLoading: true, txt: `如果您的浏览器屏蔽了鼠标右键，可按键盘上的Ctrl键代替...` });
                                    app.gameTipList.unshift({ noPadding: true, showLoading: true, txt: `游戏已经登陆成功，部分大区登录较慢，请<strong><span class='text-primary'>耐心等待</span></strong>游戏画面，大概几分钟.之后请自行选择角色领取...` });
                                    $('#closeAQModel').modal('show')
                                    break;
                            }
                            break;
                        case "nowUserQueue"://获取当前派对人数
                            if (obj.msg1 == "y") { //排到我了
                                setTimeout(function () {
                                    app.SetMusic();
                                }, 4000);
                                app.Matching(5);
                                app.gameTipList.unshift({ showLoading: false, txt: "口令的可使用次数-1..." });
                                document.getElementById("myaudio").play();//播放提示
                                app.codeMsg.hasCount = app.codeMsg.hasCount - 1;
                                app.codeMsg.usedToday = app.codeMsg.usedToday + 1;
                                return;
                            }

                            app.queueMsg = {
                                queCount: obj.msg2,
                                whereMe: obj.msg3,
                                imInQueue: obj.msg1 == "False" ? false : true,
                                matchNum: obj.msg4
                            }
                            break;
                        case "backMessage": //服务端返回的通用消息
                            switch (obj.msg1) {
                                case "1": //验证口令返回的数据
                                    app.socketIsOk = true;
                                    if (obj.msg2 == "1") {//成功
                                        var json2 = JSON.parse(obj.msg4);
                                        app.codeMsg = {
                                            allCount: json2.allCount, //发行的总额度
                                            hasCount: json2.hasCount,//剩余可用次数
                                            mark: json2.mark, //中文说明
                                            everyDayCanUse: json2.everyDayCanUse, //每日最多可用次数
                                            usedToday: json2.usedToday //今日已使用次数
                                        }

                                        app.showPage = "page_2"

                                        //申请排队
                                        sendSocket({
                                            code: "userInQueue",
                                            msg1: localStorage.Agency || ""
                                        });
                                        toast("", "<strong><span class='text-success'>暂不支持手机令牌（动态6位密码）</span>如果您开启了手机令牌，请在APP中暂时关闭,否则无法登录</strong>", 11000)

                                        //获取历史记录
                                        app.getHisFromCode();
                                    } else if (obj.msg2 == "2") {
                                        toast("提示", "这个口令可能失效了,请购买新的口令")
                                    }
                                    else if (obj.msg2 == "3") {
                                        toast("提示", "你输入的口令已经没有可用次数了,请购买新的口令")
                                    }
                                    else if (obj.msg2 == "4") {
                                        toast("提示", "这个口令今天使用次数已经到了上限" + obj.msg5 + ",明天再来吧")
                                    }
                                    break;
                                case "2"://匹配断开
                                    toast("提示", "你与云电脑的连接断开了,4秒后将返回首页", 4000)
                                    setTimeout(function () {
                                        location.reload()
                                    }, 4000);
                                    break;
                                case "3"://断线重连之已经匹配了
                                    toast("提示", "正在重新连接...", 4000)
                                    app.gameTipList.unshift({ txt: "正在尝试重新连接..." });
                                    app.showPage = "page_3";
                                    app.nowTerminalState = "5";
                                    getImage();
                                    break;
                            }
                            break;
                        case "serverMessage"://服务器发送的其他消息
                            switch (obj.msg1) {
                                case "matchHasTime"://匹配剩余时间
                                    app.matchedHasTime = obj.msg2;

                                    if (new Date() - app.lastTimeGetNewImage > 25000) {
                                        toast("", "游戏画面长时间未更新，可能是意外闪退了。请尝试F5刷新页面...如果仍未正常显示，请点击左上角的“重启游戏”按钮.");
                                        app.lastTimeGetNewImage = new Date();
                                    }
                                    break;
                                case "elsePage"://socket失效断开
                                    app.onCloseReLoad = false;
                                    document.body.innerHTML = "<h5>你已经在新标签页打开了本网站</br>所以这个页面失效了。</h5>"
                                    document.title = "请勿重复打开页面"
                                    window.socket.close();
                                    break;
                                case "inqueue"://在排队中
                                    app.showPage = "page_2";
                                    break;
                            }
                            break;
                        case "closeSocket"://退出
                            location.reload();
                            break;
                        case "alert"://弹出窗体
                            toast("提示", obj.msg1, 4000)
                            alert(obj.msg1);
                            break


                    }
                };

                socket.onclose = function (a, b) {
                    toast("哎呀", "连接被断开了", 10000);
                    console.log("连接断开close：");
                    console.log(a);

                    //自动重连
                    setTimeout(function () {
                        if (app.onCloseReLoad) {
                            toast("...", "正在尝试重新连接", 10000);
                            openSocket();
                        }
                    }, 3000);

                };
                socket.onerror = function (a) {
                    toast("提示", "连接出错了", 10000)
                    console.log("socket error");
                    console.log(a);
                };
            } catch (e) {
                toast("哎呀", "服务链接失败了，可能正在维护", 5000);
                console.log("服务连接失败");
            }
        }

        //获取图像
        function getImage() {
            sendSocket({
                code: "userGetPic",
                msg1: app.imRez.toString(),
                msg2: new Date().getTime()
            });
            app.lastTimeGetImage = new Date();
        }


        $("#canvasScreen").unbind();
        //左键
        $("#canvasScreen").mousedown(function (e) {
            e.stopPropagation();   //表示阻止向父元素冒泡
            e.preventDefault();     //阻止 方法阻止元素发生默认的行为（例如，当点击提交按钮时阻止对表单的提交或者a标签）
            if (e.button != 0) {//左键
                return;
            }

            var x = parseInt(e.offsetX / $("#canvasScreen").width() * app.baseImageXy.x);
            var y = parseInt(e.offsetY / $("#canvasScreen").height() * app.baseImageXy.y);



            sendSocket({
                code: "userButtonClick",
                msg1: "1",
                msg2: x,
                msg3: y,
                msg4: "1"
            });
        });
        //左键抬起
        $("#canvasScreen").mouseup(function (e) {
            e.stopPropagation();   //表示阻止向父元素冒泡
            e.preventDefault();     //阻止 方法阻止元素发生默认的行为（例如，当点击提交按钮时阻止对表单的提交或者a标签）
            if (e.button != 0) {//左键
                return;
            }


            var x = parseInt(e.offsetX / $("#canvasScreen").width() * app.baseImageXy.x);
            var y = parseInt(e.offsetY / $("#canvasScreen").height() * app.baseImageXy.y);


            sendSocket({
                code: "userButtonClick",
                msg1: "1",
                msg2: x,
                msg3: y,
                msg4: "2"
            });
        });
        // 右键
        $("#canvasScreen").contextmenu(function (e) {
            e.stopPropagation();   //表示阻止向父元素冒泡
            e.preventDefault();     //阻止 方法阻止元素发生默认的行为（例如，当点击提交按钮时阻止对表单的提交或者a标签）

            var x = parseInt(e.offsetX / $("#canvasScreen").width() * app.baseImageXy.x);
            var y = parseInt(e.offsetY / $("#canvasScreen").height() * app.baseImageXy.y);

            sendSocket({
                code: "userButtonClick",
                msg1: "2",
                msg2: x,
                msg3: y,
                msg4: "0"
            });
        })
        var downKeys = {};
        $("body").keydown(function (a) {
            if (app.showPage == "page_3") {

                if (downKeys[a.code] == 'down') {
                    return;
                }
                downKeys[a.code] = 'down'
                console.log("down:" + a.code);

                //如果按下ctrl 则发送鼠标右键
                if (a.code == "ControlLeft" || a.code == "ControlRight") {
                    sendSocket({
                        code: "userButtonClick",
                        msg1: "2",
                        msg2: nowMousexy.x,
                        msg3: nowMousexy.y,
                        msg4: "0"
                    });
                    return;
                }

                sendSocket({
                    code: "userKeyboard",
                    msg1: a.code,
                    msg2: (a.code == "ShiftLeft" || a.code == "ShiftRight") ? "1" : "0"
                });
            }

        });
        $("body").keyup(function (a) {
            console.log("up:" + a.code);
            downKeys[a.code] = "";

            if (a.code == "ShiftLeft" || a.code == "ShiftRight") {
                sendSocket({
                    code: "userKeyboard",
                    msg1: a.code,
                    msg2: "2"
                });
            }

        });


        //鼠标移动
        var lastTime = new Date();//频率控制
        var nowMousexy = { x: 0, y: 0 }//当前鼠标位置
        $("#canvasScreen").mousemove(function (e) {
            e.preventDefault() // 阻止右键菜单默认行为


            //这些状态才转发鼠标
            if (["4", "4-1", "5"].indexOf(app.nowTerminalState) >= 0) {
                var x = parseInt(e.offsetX / $("#canvasScreen").width() * app.baseImageXy.x);
                var y = parseInt(e.offsetY / $("#canvasScreen").height() * app.baseImageXy.y);

                nowMousexy = { x: x, y: y }
                if (new Date() - lastTime > 50) {
                    lastTime = new Date();

                    sendSocket({
                        code: "mouseMove",
                        msg1: x,
                        msg2: y
                    });
                }
            }
        });

        //localStorage.Agency = getQueryVariable("ag");
        localStorage.Agency = "";
        openSocket();



        function sendSocket(obj) {
            try {
                socket.send(JSON.stringify(obj));
            } catch (e) { }
        }

        //定期发送pin消息 长时间未收到信息将断开连接
        var lastSendtime = new Date();
        setInterval(function () {
            if (new Date() - lastSendtime > 4000) {
                lastSendtime = new Date();
                socket.send(JSON.stringify({
                    code: "ping"
                }));
            }

        }, 2000);
    </script>

    <script>
        const animateCSS = (element, animation, prefix = 'animate__') =>
            // We create a Promise and return it
            new Promise((resolve, reject) => {
                const animationName = `${prefix}${animation}`;
                const node = document.querySelector(element);

                node.classList.add(`${prefix}animated`, animationName);

                // When the animation ends, we clean the classes and resolve the Promise
                function handleAnimationEnd(event) {
                    event.stopPropagation();
                    node.classList.remove(`${prefix}animated`, animationName);
                    resolve('Animation ended');
                }

                node.addEventListener('animationend', handleAnimationEnd, { once: true });
            });
    </script>

</body>
</html>
